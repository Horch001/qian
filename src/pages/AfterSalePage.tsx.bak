import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Package, ChevronDown, ChevronUp } from 'lucide-react';
import { Language, Translations } from '../types';

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000';

interface AfterSalePageProps {
  language: Language;
  translations: Translations;
}

export const AfterSalePage: React.FC<AfterSalePageProps> = ({ language }) => {
  const navigate = useNavigate();
  const [afterSales, setAfterSales] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'ALL' | 'PENDING' | 'COMPLETED' | 'REJECTED'>('ALL');
  const [expandedCards, setExpandedCards] = useState<Set<string>>(new Set());

  const getText = (obj: { [key: string]: string }) => obj[language] || obj.zh;

  useEffect(() => {
    fetchAfterSales();
  }, []);

  const fetchAfterSales = async () => {
    try {
      const token = localStorage.getItem('authToken');
      
      // è·å–æ‰€æœ‰å•†å®¶çš„å”®åè®¢å•
      const merchantsResponse = await fetch(`${API_URL}/api/v1/merchants/my/all`, {
        headers: { 'Authorization': `Bearer ${token}` },
      });
      
      if (!merchantsResponse.ok) {
        alert('è·å–å•†å®¶ä¿¡æ¯å¤±è´¥');
        setLoading(false);
        return;
      }
      
      const merchants = await merchantsResponse.json();
      
      if (!merchants || merchants.length === 0) {
        alert('æ‚¨è¿˜ä¸æ˜¯å•†å®¶ï¼Œæ— æ³•æŸ¥çœ‹å”®åç®¡ç†');
        setLoading(false);
        return;
      }
      
      // è·å–æ‰€æœ‰å•†å®¶çš„å”®åè®¢å•ï¼Œå¹¶é™„åŠ åº—é“ºä¿¡æ¯
      const allAfterSales: any[] = [];
      for (const merchant of merchants) {
        const response = await fetch(`${API_URL}/api/v1/after-sales/merchant?merchantId=${merchant.id}`, {
          headers: { 'Authorization': `Bearer ${token}` },
        });
        
        if (response.ok) {
          const data = await response.json();
          // ç»™æ¯ä¸ªå”®åè®¢å•é™„åŠ åº—é“ºåç§°
          const dataWithShop = (data || []).map((item: any) => ({
            ...item,
            shopName: merchant.shopName,
          }));
          allAfterSales.push(...dataWithShop);
        }
      }
      
      // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åº
      allAfterSales.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
      
      setAfterSales(allAfterSales);
    } catch (error) {
      console.error('åŠ è½½å”®ååˆ—è¡¨å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleReply = async (id: string, agreed: boolean) => {
    const reply = prompt(getText({ 
      zh: agreed ? 'è¯·è¾“å…¥åŒæ„ç†ç”±ï¼ˆå¯é€‰ï¼‰' : 'è¯·è¾“å…¥æ‹’ç»ç†ç”±', 
      en: agreed ? 'Enter reason (optional)' : 'Enter rejection reason',
      ko: agreed ? 'ì´ìœ  ì…ë ¥ (ì„ íƒ)' : 'ê±°ë¶€ ì´ìœ  ì…ë ¥',
      vi: agreed ? 'Nháº­p lÃ½ do (tÃ¹y chá»n)' : 'Nháº­p lÃ½ do tá»« chá»‘i'
    }));
    
    if (!agreed && !reply) return;

    try {
      const token = localStorage.getItem('authToken');
      const response = await fetch(`${API_URL}/api/v1/after-sales/${id}/merchant-reply`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify({ agreed, reply: reply || '' }),
      });

      if (response.ok) {
        alert(getText({ zh: 'æ“ä½œæˆåŠŸ', en: 'Success', ko: 'ì„±ê³µ', vi: 'ThÃ nh cÃ´ng' }));
        fetchAfterSales();
      } else {
        const error = await response.json();
        alert(error.message || getText({ zh: 'æ“ä½œå¤±è´¥', en: 'Failed', ko: 'ì‹¤íŒ¨', vi: 'Tháº¥t báº¡i' }));
      }
    } catch (error: any) {
      alert(error.message || getText({ zh: 'æ“ä½œå¤±è´¥', en: 'Failed', ko: 'ì‹¤íŒ¨', vi: 'Tháº¥t báº¡i' }));
    }
  };

  const handleConfirmReturn = async (id: string) => {
    if (!confirm(getText({ zh: 'ç¡®è®¤å·²æ”¶åˆ°é€€è´§ï¼Ÿ', en: 'Confirm received?', ko: 'ë°˜í’ˆ í™•ì¸?', vi: 'XÃ¡c nháº­n Ä‘Ã£ nháº­n?' }))) {
      return;
    }

    try {
      const token = localStorage.getItem('authToken');
      const response = await fetch(`${API_URL}/api/v1/after-sales/${id}/merchant-confirm`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      });

      if (response.ok) {
        alert(getText({ zh: 'ç¡®è®¤æˆåŠŸï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é€€æ¬¾', en: 'Confirmed, refund processing', ko: 'í™•ì¸ë¨, í™˜ë¶ˆ ì²˜ë¦¬ ì¤‘', vi: 'ÄÃ£ xÃ¡c nháº­n, Ä‘ang hoÃ n tiá»n' }));
        fetchAfterSales();
      } else {
        const error = await response.json();
        alert(error.message || getText({ zh: 'æ“ä½œå¤±è´¥', en: 'Failed', ko: 'ì‹¤íŒ¨', vi: 'Tháº¥t báº¡i' }));
      }
    } catch (error: any) {
      alert(error.message || getText({ zh: 'æ“ä½œå¤±è´¥', en: 'Failed', ko: 'ì‹¤íŒ¨', vi: 'Tháº¥t báº¡i' }));
    }
  };

  const getStatusText = (status: string) => {
    const statusMap: any = {
      PENDING: { zh: 'å¾…å¤„ç†', en: 'Pending', ko: 'ëŒ€ê¸° ì¤‘', vi: 'Chá» xá»­ lÃ½' },
      MERCHANT_AGREED: { zh: 'å·²åŒæ„', en: 'Agreed', ko: 'ë™ì˜ë¨', vi: 'ÄÃ£ Ä‘á»“ng Ã½' },
      MERCHANT_REJECTED: { zh: 'å·²æ‹’ç»', en: 'Rejected', ko: 'ê±°ë¶€ë¨', vi: 'ÄÃ£ tá»« chá»‘i' },
      BUYER_SHIPPING: { zh: 'ä¹°å®¶é€€è´§ä¸­', en: 'Returning', ko: 'ë°˜í’ˆ ì¤‘', vi: 'Äang tráº£ hÃ ng' },
      MERCHANT_RECEIVED: { zh: 'å·²æ”¶è´§', en: 'Received', ko: 'ìˆ˜ë ¹ë¨', vi: 'ÄÃ£ nháº­n' },
      REFUNDING: { zh: 'é€€æ¬¾ä¸­', en: 'Refunding', ko: 'í™˜ë¶ˆ ì¤‘', vi: 'Äang hoÃ n tiá»n' },
      COMPLETED: { zh: 'å·²å®Œæˆ', en: 'Completed', ko: 'ì™„ë£Œ', vi: 'HoÃ n táº¥t' },
      CANCELLED: { zh: 'å·²å–æ¶ˆ', en: 'Cancelled', ko: 'ì·¨ì†Œë¨', vi: 'ÄÃ£ há»§y' },
    };
    return getText(statusMap[status] || { zh: status, en: status, ko: status, vi: status });
  };

  const getTypeText = (type: string) => {
    const typeMap: any = {
      REFUND_ONLY: { zh: 'ä»…é€€æ¬¾', en: 'Refund Only', ko: 'í™˜ë¶ˆë§Œ', vi: 'Chá»‰ hoÃ n tiá»n' },
      RETURN_REFUND: { zh: 'é€€è´§é€€æ¬¾', en: 'Return & Refund', ko: 'ë°˜í’ˆ í™˜ë¶ˆ', vi: 'Tráº£ hÃ ng hoÃ n tiá»n' },
      EXCHANGE: { zh: 'æ¢è´§', en: 'Exchange', ko: 'êµí™˜', vi: 'Äá»•i hÃ ng' },
    };
    return getText(typeMap[type] || { zh: type, en: type, ko: type, vi: type });
  };

  const filteredAfterSales = afterSales.filter(item => {
    if (activeTab === 'ALL') return true;
    if (activeTab === 'PENDING') return item.status === 'PENDING';
    if (activeTab === 'COMPLETED') return ['COMPLETED', 'MERCHANT_AGREED', 'BUYER_SHIPPING', 'MERCHANT_RECEIVED', 'REFUNDING'].includes(item.status);
    if (activeTab === 'REJECTED') return ['MERCHANT_REJECTED', 'CANCELLED'].includes(item.status);
    return true;
  });

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-purple-600 to-pink-500 flex justify-center">
        <div className="w-full max-w-md flex items-center justify-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-purple-600 to-pink-500 flex justify-center">
      <div className="w-full max-w-md flex flex-col min-h-screen">
        {/* Header */}
        <header className="p-4 flex items-center justify-center relative">
          <button onClick={() => navigate(-1)} className="text-white absolute left-4">
            <ArrowLeft size={24} />
          </button>
          <h1 className="text-lg font-bold text-white">
            {getText({ zh: 'å”®åç®¡ç†', en: 'After Sales', ko: 'ì• í”„í„° ì„œë¹„ìŠ¤', vi: 'Dá»‹ch vá»¥ sau bÃ¡n' })}
          </h1>
        </header>

        {/* Tabs */}
        <div className="px-4 pb-3">
          <div className="flex gap-2 overflow-x-auto scrollbar-hide">
            {(['ALL', 'PENDING', 'COMPLETED', 'REJECTED'] as const).map((tab) => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${
                  activeTab === tab
                    ? 'bg-white text-purple-600'
                    : 'bg-white/20 text-white'
                }`}
              >
                {tab === 'ALL' ? getText({ zh: 'å…¨éƒ¨', en: 'All', ko: 'ì „ì²´', vi: 'Táº¥t cáº£' }) :
                 tab === 'PENDING' ? getText({ zh: 'å¾…å¤„ç†', en: 'Pending', ko: 'ëŒ€ê¸°', vi: 'Chá»' }) :
                 tab === 'COMPLETED' ? getText({ zh: 'å·²å®Œæˆ', en: 'Completed', ko: 'ì™„ë£Œ', vi: 'HoÃ n táº¥t' }) :
                 getText({ zh: 'å·²æ‹’ç»', en: 'Rejected', ko: 'ê±°ë¶€ë¨', vi: 'ÄÃ£ tá»« chá»‘i' })}
              </button>
            ))}
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 p-4 overflow-y-auto">
          {filteredAfterSales.length === 0 ? (
            <div className="text-center py-12">
              <Package size={48} className="mx-auto text-white/50 mb-3" />
              <p className="text-white/70">
                {getText({ zh: 'æš‚æ— å”®åç”³è¯·', en: 'No after sales', ko: 'ì• í”„í„° ì„œë¹„ìŠ¤ ì—†ìŒ', vi: 'ChÆ°a cÃ³ yÃªu cáº§u' })}
              </p>
            </div>
          ) : (
            <div className="space-y-2">
              {filteredAfterSales.map((item) => {
                const isExpanded = expandedCards.has(item.id);
                const toggleExpand = () => {
                  const newExpanded = new Set(expandedCards);
                  if (isExpanded) {
                    newExpanded.delete(item.id);
                  } else {
                    newExpanded.add(item.id);
                  }
                  setExpandedCards(newExpanded);
                };

                return (
                  <div key={item.id} className="bg-white rounded-lg p-3">
                    {/* å¤´éƒ¨ï¼šåº—é“ºå + çŠ¶æ€ + å±•å¼€æŒ‰é’® */}
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex items-center gap-2 flex-1">
                        <span className="text-xs font-bold text-purple-600">ğŸ“¦ {item.shopName}</span>
                        <span className="text-xs text-gray-500">Â·</span>
                        <span className="text-xs text-gray-600">{getTypeText(item.type)}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                          item.status === 'PENDING' ? 'bg-yellow-100 text-yellow-600' :
                          item.status === 'COMPLETED' ? 'bg-green-100 text-green-600' :
                          item.status === 'MERCHANT_REJECTED' || item.status === 'CANCELLED' ? 'bg-red-100 text-red-600' :
                          'bg-blue-100 text-blue-600'
                        }`}>
                          {getStatusText(item.status)}
                        </span>
                        <button onClick={toggleExpand} className="text-gray-500 hover:text-gray-700">
                          {isExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                        </button>
                      </div>
                    </div>

                    {/* ç®€è¦ä¿¡æ¯ - å§‹ç»ˆæ˜¾ç¤º */}
                    <div className="flex justify-between items-center text-xs">
                      <span className="text-gray-500 truncate flex-1">{item.orderNo}</span>
                      <span className="font-bold text-red-600 ml-2">{item.amount}Ï€</span>
                    </div>

                    {/* è¯¦ç»†ä¿¡æ¯ - å±•å¼€æ—¶æ˜¾ç¤º */}
                    {isExpanded && (
                      <div className="mt-2 pt-2 border-t">
                        {/* å•†å“ä¿¡æ¯ */}
                        {item.order?.items && item.order.items.length > 0 ? (
                    <div className="flex gap-2 mb-2">
                      {item.order.items[0].product?.images?.[0] && (
                        <img 
                          src={item.order.items[0].product.images[0]} 
                          alt={item.order.items[0].product.title} 
                          className="w-16 h-16 object-cover rounded" 
                        />
                      )}
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium truncate">
                          {item.order.items[0].product?.title || getText({ zh: 'å•†å“', en: 'Product', ko: 'ìƒå“', vi: 'Sáº£n pháº©m' })}
                        </p>
                        <p className="text-xs text-gray-500">
                          {Number(item.order.items[0].price).toFixed(2)}Ï€ Ã— {item.order.items[0].quantity}
                          {item.order.items.length > 1 && ` ç­‰${item.order.items.length}ä»¶`}
                        </p>
                        <p className="text-xs text-gray-600 mt-1">
                          {getText({ zh: 'ä¹°å®¶', en: 'Buyer', ko: 'êµ¬ë§¤ì', vi: 'NgÆ°á»i mua' })}: {item.buyerName || getText({ zh: 'æœªçŸ¥', en: 'Unknown', ko: 'ì•Œ ìˆ˜ ì—†ìŒ', vi: 'KhÃ´ng rÃµ' })}
                        </p>
                      </div>
                    </div>
                  ) : (
                    <div className="mb-2 pb-2 border-b">
                      <p className="text-xs text-gray-500">{getText({ zh: 'ä¹°å®¶', en: 'Buyer', ko: 'êµ¬ë§¤ì', vi: 'NgÆ°á»i mua' })}: {item.buyerName || getText({ zh: 'æœªçŸ¥', en: 'Unknown', ko: 'ì•Œ ìˆ˜ ì—†ìŒ', vi: 'KhÃ´ng rÃµ' })}</p>
                      <p className="text-xs text-gray-400">{getText({ zh: 'å•†å“ä¿¡æ¯å·²åˆ é™¤', en: 'Product deleted', ko: 'ìƒí’ˆ ì‚­ì œë¨', vi: 'Sáº£n pháº©m Ä‘Ã£ xÃ³a' })}</p>
                    </div>
                  )}

                  {/* æ”¶è´§åœ°å€ */}
                  {item.order?.address && (
                    <div className="mb-2 pb-2 border-b">
                      <p className="text-xs text-gray-500">
                        {getText({ zh: 'æ”¶è´§äºº', en: 'Receiver', ko: 'ìˆ˜ë ¹ì¸', vi: 'NgÆ°á»i nháº­n' })}: {item.order.address.receiverName} {item.order.address.receiverPhone}
                      </p>
                      <p className="text-xs text-gray-500 truncate">
                        {item.order.address.province} {item.order.address.city} {item.order.address.district} {item.order.address.detail}
                      </p>
                    </div>
                  )}

                        {/* ç”³è¯·ç†ç”± */}
                  <div className="mb-2">
                    <p className="text-xs text-gray-500">{getText({ zh: 'ç†ç”±', en: 'Reason', ko: 'ì´ìœ ', vi: 'LÃ½ do' })}:</p>
                    <p className="text-xs text-gray-700 line-clamp-2">{item.reason}</p>
                    {item.description && (
                      <p className="text-xs text-gray-600 mt-1 line-clamp-1">{item.description}</p>
                    )}
                  </div>

                  {/* å•†å®¶å›å¤ */}
                  {item.merchantReply && (
                    <div className="mb-2 p-2 bg-gray-50 rounded">
                      <p className="text-xs text-gray-500">{getText({ zh: 'å›å¤', en: 'Reply', ko: 'ë‹µë³€', vi: 'Pháº£n há»“i' })}:</p>
                      <p className="text-xs text-gray-700">{item.merchantReply}</p>
                    </div>
                  )}

                  {/* é€€è´§ç‰©æµ */}
                  {item.returnCompany && item.returnTrackingNo && (
                    <div className="mb-2 p-2 bg-blue-50 rounded">
                      <p className="text-xs text-gray-700">
                        {item.returnCompany} - {item.returnTrackingNo}
                      </p>
                    </div>
                  )}

                        {/* æ“ä½œæŒ‰é’® */}
                        {item.status === 'PENDING' && (
                          <div className="flex gap-2 mt-3">
                            <button
                              onClick={() => handleReply(item.id, false)}
                              className="flex-1 py-2 bg-red-500 text-white rounded-lg text-sm font-bold hover:bg-red-600"
                            >
                              {getText({ zh: 'æ‹’ç»', en: 'Reject', ko: 'ê±°ë¶€', vi: 'Tá»« chá»‘i' })}
                            </button>
                            <button
                              onClick={() => handleReply(item.id, true)}
                              className="flex-1 py-2 bg-green-500 text-white rounded-lg text-sm font-bold hover:bg-green-600"
                            >
                              {getText({ zh: 'åŒæ„', en: 'Agree', ko: 'ë™ì˜', vi: 'Äá»“ng Ã½' })}
                            </button>
                          </div>
                        )}

                  {item.status === 'BUYER_SHIPPING' && (
                    <button
                      onClick={() => handleConfirmReturn(item.id)}
                      className="w-full py-2 bg-purple-600 text-white rounded-lg text-sm font-bold hover:bg-purple-700"
                    >
                      {getText({ zh: 'ç¡®è®¤æ”¶è´§', en: 'Confirm', ko: 'í™•ì¸', vi: 'XÃ¡c nháº­n' })}
                    </button>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};
